!function(e){function t(o){if(n[o])return n[o].exports;var a=n[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(245)},245:function(e,t,n){var o,a;(function(e){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=n(247),s=n(248);window.WebIM="undefined"!=typeof WebIM?WebIM:{},WebIM.WebRTC=WebIM.WebRTC||{},WebIM.WebRTC.Call=s,WebIM.WebRTC.Util=r,"object"===i(e)&&"object"===i(e.exports)?e.exports=WebIM.WebRTC:(o=[],a=function(){return WebIM.WebRTC}.apply(t,o),!(void 0!==a&&(e.exports=a))),/Chrome/.test(navigator.userAgent)&&(WebIM.WebRTC.supportPRAnswer=navigator.userAgent.split("Chrome/")[1].split(".")[0]>=50)}).call(t,n(246)(e))},246:function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},247:function(e,t){"use strict";function n(){}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var o,a=e,i=[];if(n=n||a.length,t)for(o=0;o<t;o++)i[o]=a[0|Math.random()*n];else{var r;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",o=0;o<36;o++)i[o]||(r=0|16*Math.random(),i[o]=a[19==o?3&r|8:r])}return i.join("")},Math.uuidFast=function(){for(var t,n=e,o=new Array(36),a=0,i=0;i<36;i++)8==i||13==i||18==i||23==i?o[i]="-":14==i?o[i]="4":(a<=2&&(a=33554432+16777216*Math.random()|0),t=15&a,a>>=4,o[i]=n[19==i?3&t|8:t]);return o.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}}();var a=function(){function e(e,n){var o=[];o.push(e);for(var a in n)o.push(n[a]);t.log.apply(t,o)}var t=this,n={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},o=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];this.log=function(){var e=arguments[0];e=arguments[0]="["+o[e]+"] ";arguments[1];WebIM&&WebIM.config&&WebIM.config.isDebug&&console.log.apply(console,arguments)},this.trace=function(){this.log&&e(n.TRACE,arguments)},this.debug=function(){this.log&&e(n.DEBUG,arguments)},this.info=function(){this.log&&e(n.INFO,arguments)},this.warn=function(){this.log&&e(n.WARN,arguments)},this.error=function(){this.log&&e(n.ERROR,arguments)},this.fatal=function(){this.log&&e(n.FATAL,arguments)}};n.prototype.logger=new a,n.prototype.parseJSON=function(e){return JSON.parse(e)};var i=(n.prototype.stringifyJSON=function(e){return JSON.stringify(e)},{}),r=i.toString,s=i.hasOwnProperty,c=s.toString,d=c.call(Object);n.prototype.isPlainObject=function(e){var t,n;return!(!e||"[object Object]"!==r.call(e))&&(!(t=Object.getPrototypeOf(e))||(n=s.call(t,"constructor")&&t.constructor,"function"==typeof n&&c.call(n)===d))};n.prototype.isArray=Array.isArray,n.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},n.prototype.type=function(e){return null==e?e+"":"object"===("undefined"==typeof e?"undefined":o(e))||"function"==typeof e?i[r.call(e)]||"object":"undefined"==typeof e?"undefined":o(e)},n.prototype.extend=function(){var e,t,n,a,i,r,s=this,c=arguments[0]||{},d=1,l=arguments.length,u=!1;for("boolean"==typeof c&&(u=c,c=arguments[d]||{},d++),"object"===("undefined"==typeof c?"undefined":o(c))||s.isFunction(c)||(c={}),d===l&&(c=this,d--);d<l;d++)if(null!=(e=arguments[d]))for(t in e)n=c[t],a=e[t],c!==a&&(u&&a&&(s.isPlainObject(a)||(i=s.isArray(a)))?(i?(i=!1,r=n&&s.isArray(n)?n:[]):r=n&&s.isPlainObject(n)?n:{},c[t]=s.extend(u,r,a)):void 0!==a&&(c[t]=a));return c},n.prototype.hasLocalStorage=function(e){return null!=localStorage.getItem(e)&&"{}"!=localStorage.getItem(e)},n.prototype.toggleClass=function(e,t){return e.hasClass(t)?void e.removeClass(t):void e.addClass(t)},n.prototype.setCookie=function(e,t,n){var o=new Date;o.setTime(o.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+o.toGMTString()},n.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},n.prototype.parseURL=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},e.exports=new n},248:function(e,t,n){"use strict";var o=n(247),a=n(249),i=n(250),r=n(251),s=n(252),c=i.RouteTo,d=i.Api,l=o.logger,u={api:null,caller:"",connection:null,pattern:null,listener:{onAcceptCall:function(e,t){},onRinging:function(e){},onTermCall:function(){},onIceConnectionStateChange:function(e){}},mediaStreamConstaints:{audio:!0,video:!0},init:function(){var e=this;if("undefined"==typeof e.connection)throw"Caller need a instance of Easemob.im.Connection";e.api=e.api||new d({imConnection:e.connection,rtcHandler:new a({imConnection:e.connection})}),e.api.onInitC=function(){e._onInitC.apply(e,arguments)},e.api.onIceConnectionStateChange=function(){e.listener.onIceConnectionStateChange.apply(e,arguments)}},makeVideoCall:function(e,t){var n=this,a={};o.extend(a,n.mediaStreamConstaints),n.mediaStreamConstaints.video=!0,this.call(e,a,t)},makeVoiceCall:function(e,t){console.log("ScareCrow");var n=this,a={};o.extend(a,n.mediaStreamConstaints),n.mediaStreamConstaints.video=!1,n.call(e,a,t)},acceptCall:function(){var e=this;e.pattern.accept()},endCall:function(e){var t=this;t.caller="",t.pattern.termCall()},call:function(e,t,n){var o=this;this.callee=this.api.jid(e);var a=new c({rtKey:"",sid:n,success:function(e){l.debug("iq to server success",e)},fail:function(e){l.debug("iq to server error",e),o.onError(e)}});this.api.reqP2P(a,t.video?1:0,t.audio?1:0,this.api.jid(e),function(e,t){return"0"==t.online?void o.listener.onError({message:"callee is not online!"}):(o._onGotServerP2PConfig(e,t),void o.pattern.initC(o.mediaStreamConstaints,n))})},_onInitC:function(e,t,n,o,a){var i=this;i.callee=e,i._rtcCfg=t.rtcCfg,i._WebRTCCfg=t.WebRTC,i.sessId=t.sessId,i.rtcId=t.rtcId,i.switchPattern("VIDEO"==t.streamType?"VIDEO":"VOICE"),i.pattern._onInitC(e,t,n,o,a)},_onGotServerP2PConfig:function(e,t){var n=this;0==t.result&&(n._p2pConfig=t,n._rtcCfg=t.rtcCfg,n._rtcCfg2=t.rtcCfg2,n.sessId=t.sessId,n.rtcId="Channel_webIM",n._rtKey=n._rtkey=t.rtKey||t.rtkey,n._rtFlag=n._rtflag=t.rtFlag||t.rtflag,n._WebRTCCfg=t.WebRTC,n.admtok=t.admtok,n.tkt=t.tkt,n.switchPattern(n.mediaStreamConstaints.audio&&n.mediaStreamConstaints.video?"VIDEO":"VOICE"))},switchPattern:function(e){var t=this;!t._WebRTCCfg&&(t.pattern=new s({callee:t.callee,_p2pConfig:t._p2pConfig,_rtcCfg:t._rtcCfg,_rtcCfg2:t._rtcCfg2,_rtKey:t._rtKey||t._rtkey,_rtFlag:t._rtFlag||t._rtflag,_sessId:t.sessId,_rtcId:t.rtcId,webRtc:new r({streamType:e,onGotLocalStream:t.listener.onGotLocalStream,onGotRemoteStream:t.listener.onGotRemoteStream,onError:t.listener.onError}),api:t.api,onAcceptCall:t.listener&&t.listener.onAcceptCall||function(){},onRinging:t.listener&&t.listener.onRinging||function(){},onTermCall:t.listener&&t.listener.onTermCall||function(){},onOtherUserOpenVoice:t.listener&&t.listener.onOtherUserOpenVoice||function(){},onOtherUserOpenVideo:t.listener&&t.listener.onOtherUserOpenVideo||function(){}}))}};e.exports=function(e){o.extend(!0,this,u,e||{}),this.init()}},249:function(e,t,n){"use strict";var o=n(247),a=o.logger,i=n(250),r=i.RouteTo,s="urn:xmpp:media-conference",c={_apiCallbacks:{},imConnection:null,_connectedSid:"",init:function(){var e=this,t=e.imConnection;t.registerConfrIQHandler=function(){var n=function(t){try{e.handleRtcMessage(t)}catch(e){throw a.error(e.stack||e),e}return!0};t.addHandler(n,s,"iq","set"),t.addHandler(n,s,"iq","get"),a.warn("Conference iq handler. registered.")}},handleRtcMessage:function(e){var t=this,n=(e.getAttribute("id"),e.getAttribute("from")||"");n.lastIndexOf("/")>=0&&(n=n.substring(0,n.lastIndexOf("/")));var i=e.getElementsByTagName("rtkey")[0].innerHTML,s=e.getElementsByTagName("sid")[0].innerHTML;(t._fromSessionID||(t._fromSessionID={}))[n]=s;var c=e.getElementsByTagName("content"),d=c[0].innerHTML,l=o.parseJSON(d),u=l,p=e.getElementsByTagName("stream_type")[0].innerHTML;""==p&&(p="VOICE"),u.streamType=p,102==u.op&&(t.singalStreamType=p);var f=l.tsxId;if(t.ctx=l.ctx,a.debug("Recv [op = "+u.op+"] [tsxId="+f+"]\r\n json :",e),n.indexOf("@")>=0)if(""==t._connectedSid&&102==u.op)t._connectedSid=s;else if(t._connectedSid!=s){if(a.debug("Error recv [op = "+u.op+"] [tsxId="+f+"]. caused by _connectedSid != fromSessionId :",t._connectedSid,s),102==u.op){var C=new r({to:n,rtKey:i,sid:s,success:function(e){a.debug("iq to server success",e)},fail:function(e){a.debug("iq to server error",e),t.onError(e)}}),g={data:{op:107,sessId:u.sessId,rtcId:u.rtcId,reason:"busy"},reason:"busy"};t.sendRtcMessage(C,g)}return}if(107==u.op){t._connectedSid="",t._fromSessionID={};var S=e.getElementsByTagName("reason");S&&S.length>0&&(u.reason=S[0].innerHTML)}if(u.sdp&&("string"==typeof u.sdp&&(u.sdp=o.parseJSON(u.sdp)),u.sdp.type&&(u.sdp.type=u.sdp.type.toLowerCase())),u.cands){"string"==typeof u.cands&&(u.cands=o.parseJSON(u.cands));for(var b=0;b<u.cands.length;b++)"string"==typeof u.cands[b]&&(u.cands[b]=o.parseJSON(u.cands[b])),u.cands[b].sdpMLineIndex=u.cands[b].mlineindex,u.cands[b].sdpMid=u.cands[b].mid,delete u.cands[b].mlineindex,delete u.cands[b].mid}if(u.rtcCfg&&"string"==typeof u.rtcCfg&&(u.rtcCfg=o.parseJSON(u.rtcCfg)),u.rtcCfg2&&"string"==typeof u.rtcCfg2&&(u.rtcCfg2=o.parseJSON(u.rtcCfg2)),u.WebRTC&&"string"==typeof u.WebRTC&&(u.WebRTC=o.parseJSON(u.WebRTC)),f&&t._apiCallbacks[f])try{t._apiCallbacks[f].callback&&t._apiCallbacks[f].callback(n,u)}catch(e){throw e}finally{delete t._apiCallbacks[f]}else t.onRecvRtcMessage(n,u,i,f,s);return!0},onRecvRtcMessage:function(e,t,n,i,r){a.debug(" form : "+e+" \r\n json :"+o.stringifyJSON(rtcJSON))},convertRtcOptions:function(e){var t=e.data.sdp;if(t){var n={type:t.type,sdp:t.sdp};t=n,t.type=t.type.toUpperCase(),t=o.stringifyJSON(t),e.data.sdp=t}var a=e.data.cands;if(a){if(o.isArray(a));else{var i=[];i.push(a),a=i}for(var r in a)if(a[r]instanceof RTCIceCandidate){var s={type:"candidate",candidate:a[r].candidate,mlineindex:a[r].sdpMLineIndex,mid:a[r].sdpMid};a[r]=o.stringifyJSON(s)}e.data.cands=a}var c=e.data.rtcCfg;c&&"string"!=typeof c&&(e.data.rtcCfg=o.stringifyJSON(c));var d=e.data.WebRTC;d&&"string"!=typeof d&&(e.data.WebRTC=o.stringifyJSON(d))},sendRtcMessage:function(e,t,n){var i=this,r=i.imConnection,c=e.tsxId||r.getUniqueId(),d=e.to||r.domain,l=e.sid||i._fromSessionID&&i._fromSessionID[d];l=l||r.getUniqueId("CONFR_"),(i._fromSessionID||(i._fromSessionID={}))[d]=l,d.indexOf("@")>=0&&""==i._connectedSid&&102==t.data.op&&(i._connectedSid=l);var u=e.rtKey||e.rtkey;u||(u="");var p=e.rtflag;p||(p=1),t.data||(t.data={}),t.data.tsxId=c,i.ctx&&(t.data.ctx=i.ctx),i.convertRtcOptions(t);var f=t.streamType||i.singalStreamType||"VIDEO";102==t.data.op&&(i.singalStreamType=f);var C=e.id||r.getUniqueId("CONFR_"),g=$iq({id:C,to:d,from:r.context.jid,type:e.type||"get"}).c("query",{xmlns:s}).c("MediaReqExt").c("rtkey").t(u).up().c("rtflag").t(p).up().c("stream_type").t(f).up().c("sid").t(l).up().c("content").t(o.stringifyJSON(t.data));107==t.data.op&&t.reason&&g.up().c("reason").t(t.reason),a.debug("Send [op = "+t.data.op+"] : \r\n",g.tree()),n&&(i._apiCallbacks[c]={callback:n});var S=function(t){e.success(t)}||function(e){a.debug("send result. op:"+t.data.op+".",e)},b=function(t){e.fail(t)}||function(e){a.debug(e)};r.context.stropheConn.sendIQ(g.tree(),S,b),107==t.data.op&&i._connectedSid&&(e.sid&&i._connectedSid!=e.sid||(i._connectedSid="",i._fromSessionID={}))}},d=function(e){o.extend(!0,this,c,e||{}),this.init()};e.exports=d},250:function(e,t,n){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(247),i=a.logger,r={rtFlag:1,success:function(e){},fail:function(e){}},s=function e(t){if(!(this instanceof e)){var n=function(e){var t=this;a.extend(!0,t,e||{})};return a.extend(!0,n.prototype,r,t||{}),n}var o=this;a.extend(!0,o,r,t||{})};t.RouteTo=s;var c={imConnection:null,rtcHandler:null,events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",103:"onReqC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEvEnter",301:"onEvExit",302:"onEvPub",303:"onEvUnpub",304:"onEvMems",204:"onEvClose",400:"onStreamControl",401:"onEvJoin",onServerError:"onServerError"},register:function(e){if("object"===("undefined"==typeof e?"undefined":o(e)))for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n,o=this;(n=o.events[e])?o[n]=t:(n=o.events[e]="on_"+e,o[n]=t)},jid:function(e){return/^.+#.+_.+@.+$/g.test(e)?e:this.imConnection.context.appKey+"_"+e+"@"+this.imConnection.domain},reqP2P:function(e,t,n,o,a){i.debug("req p2p ...");var r={data:{op:0,video:t,audio:n,peer:o}};this.rtcHandler.sendRtcMessage(e,r,a)},newCfr:function(e,t,n,o){i.debug("newCfr ...");var a=this,r={data:{op:1}};t&&(r.data.reqTkt=t),n&&(r.data.password=n),a.rtcHandler.sendRtcMessage(e,r,o)},enter:function(e,t,n,o,a,r,s){i.debug("enter ...");var c=this,d={data:{op:200}};t&&(d.data.WebRTCId=t),n&&(d.data.reqMembers=n),o&&(d.data.tkt=o),a&&(d.data.nonce=a),r&&(d.data.digest=r),c.rtcHandler.sendRtcMessage(e,d,s)},ping:function(e,t,n){i.debug("ping ...");var o=this,a={data:{op:100}};t&&(a.data.sessId=t),o.rtcHandler.sendRtcMessage(e,a,n)},streamControl:function(e,t,n,o,a){i.debug("streamControl ...");var r=this,s={data:{op:400}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),"undefined"!=typeof o&&null!=o&&(s.data.controlType=o),r.rtcHandler.sendRtcMessage(e,s,a)},reqTkt:function(e,t,n){i.debug("reqTkt ...");var o=this,a={data:{op:3}};t&&(a.data.WebRTCId=t),o.rtcHandler.sendRtcMessage(e,a,n)},initC:function(e,t,n,o,a,r,s,c,d,l,u,p,f){i.debug("initC ...");var C={data:{op:102}};C.streamType=t||"VIDEO",n&&(C.data.WebRTCId=n),o&&(C.data.tkt=o),a&&(C.data.sessId=a),r&&(C.data.rtcId=r),s&&(C.data.pubS=s),c&&(C.data.subS=c),d&&(C.data.sdp=d),l&&(C.data.cands=l),u&&(C.data.rtcCfg=u),p&&(C.data.WebRTC=p),this.rtcHandler.sendRtcMessage(e,C,f)},tcklC:function(e,t,n,o,a,r){i.debug("tcklC ...");var s=this,c={data:{op:105}};t&&(c.data.sessId=t),n&&(c.data.rtcId=n),o&&(c.data.sdp=o),a&&(c.data.cands=a),s.rtcHandler.sendRtcMessage(e,c,r)},ansC:function(e,t,n,o,a,r,s,c){i.debug("ansC ...");var d=this,l={data:{op:106}};t&&(l.data.sessId=t),n&&(l.data.rtcId=n),o&&(l.data.sdp=o),a&&(l.data.cands=a),s===!1&&(l.data.enableVoice=s),c===!1&&(l.data.enableVideo=c),d.rtcHandler.sendRtcMessage(e,l,r)},acptC:function(e,t,n,o,a,r,s,c,d){i.debug("acptC ...");var l=this,u={data:{op:104}};t&&(u.data.sessId=t),n&&(u.data.rtcId=n),o&&(u.data.sdp=o),a&&(u.data.cands=a),r&&(u.data.ans=r),c===!1&&(u.data.enableVoice=c),d===!1&&(u.data.enableVideo=d),l.rtcHandler.sendRtcMessage(e,u,s)},getMems:function(e,t,n,o){i.debug("getMems ...");var a=this,r={data:{op:203}};t&&(r.data.WebRTCId=t),n&&(r.data.sessId=n),a.rtcHandler.sendRtcMessage(e,r,o)},subC:function(e,t,n,o,a){i.debug("subC ...");var r=this,s={data:{op:205}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),o&&(s.data.subS=o),r.rtcHandler.sendRtcMessage(e,s,a)},usubC:function(e,t,n,o){i.debug("usubC ...");var a=this,r={data:{op:206}};t&&(r.data.sessId=t),n&&(r.data.rtcId=n),a.rtcHandler.sendRtcMessage(e,r,o)},termC:function(e,t,n,o,a){i.debug("termC ...");var r=this,s={data:{op:107}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),o&&(s.reason=o),r.rtcHandler.sendRtcMessage(e,s,a)},exit:function(e,t,n,o){i.debug("exit ...");var a=this,r={data:{op:201}};t&&(r.data.WebRTCId=t),n&&(r.data.sessId=n),a.rtcHandler.sendRtcMessage(e,r,o)},delCfr:function(e,t,n,o){i.debug("delCfr ...");var a=this,r={data:{op:2}};t&&(r.data.WebRTCId=t),n&&(r.data.admtok=n),a.rtcHandler.sendRtcMessage(e,r,o)}};t.Api=function(e){function t(e,t,o,a,r){if(0!=t.result&&n.onServerError)n.onServerError.call(n,e,t,o,a,r);else{var s;n.events[t.op]&&(s=n[n.events[t.op]])?s.call(n,e,t,o,a,r):i.info("can not handle(recvRtcMessage) the op: "+t.op,t)}}var n=this;a.extend(!0,this,c,e||{}),this.rtcHandler.onRecvRtcMessage=t}},251:function(e,t,n){"use strict";var o=n(247),a=o.logger,i={bytesPrev:null,timestampPrev:null,sentBytesPrev:null,sentTimestampPrev:null,printStats:function(e){var t=this;e.getStats(null,function(e){t.parseRecvStatistics(e,function(e,t){a.info(new Date,"RECV ",e,t)},function(e,t){a.info(new Date,"SEND ",e,t)})})},stopIntervalPrintStats:function(){var e=this;e._printIntervalId&&window.clearInterval(e._printIntervalId),e._printIntervalId=null},intervalPrintStats:function(e,t){},_intervalPrintStats:function(e,t){var n=this;n._printIntervalId&&window.clearInterval(n._printIntervalId),n._printIntervalId=window.setInterval(function(){n.printStats(e)},1e3*t)},parseRecvStatistics:function(e,t,n){var o,a,i,r=this,s=null,c=null;Object.keys(e).forEach(function(t){var a=e[t],i=a.timestamp;if("inboundrtp"===a.type&&"audio"===a.mediaType)o=Math.floor(a.bitrateMean/1024);else if("ssrc"===a.type&&a.bytesReceived)if("video"===a.mediaType);else{var c=a.bytesReceived;r.timestampPrev&&(o=8*(c-r.bytesPrev)/(i-r.timestampPrev),o=Math.floor(o)),r.bytesPrev=c,r.timestampPrev=i}if(("candidatepair"===a.type&&a.selected||"googCandidatePair"===a.type&&"true"===a.googActiveConnection)&&(s=a),"outboundrtp"===a.type&&"audio"===a.mediaType)n("audio Bitrate",Math.floor(a.bitrateMean/1024)+" kbps");else if("ssrc"===a.type&&a.bytesSent&&a.googFrameHeightSent){var c=a.bytesSent;if(r.sentTimestampPrev){var d=8*(c-r.sentBytesPrev)/(i-r.sentTimestampPrev);d=Math.floor(d),n("audio Bitrate",d+" kbps"),n("audio Size",a.googFrameWidthSent+"x"+a.googFrameHeightSent)}r.sentBytesPrev=c,r.sentTimestampPrev=i}}),s&&s.remoteCandidateId&&(c=e[s.remoteCandidateId]),c&&c.ipAddress&&c.portNumber&&t("Peer",c.ipAddress+":"+c.portNumber),t("audio Bitrate",o+" kbps"),i&&t("audio Size",a+"x"+i)}},r=function(e){o.extend(this,i,e||{})},s=new r,c={headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e){var t=e.indexOf("m=audio");return t>=0?e.slice(0,t):(t=e.indexOf("m=video"),t>=0?e.slice(0,t):e)},_parseAudioSection:function(e){var t=e.indexOf("m=audio");if(t>=0){var n=e.indexOf("m=video");return e.slice(t,n<0?e.length:n)}},_parseVideoSection:function(e){var t=e.indexOf("m=video");if(t>=0)return e.slice(t)},spiltSection:function(e){var t=this;t.headerSection=t._parseHeaderSection(e),t.audioSection=t._parseAudioSection(e),t.videoSection=t._parseVideoSection(e)},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),o=0;o<n.length;o++)"\n"!=n[o]&&t.push(n[o]);return t.join("\n")},removeField_msid:function(e){for(var t=[],n=e.split(/a=msid:[^\n]+/g),o=0;o<n.length;o++)"\n"!=n[o]&&t.push(n[o]);e=t.join("\n"),t=[],n=e.split(/[\n]+/g);for(var o=0;o<n.length;o++)"\n"!=n[o]&&t.push(n[o]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t=this,n="a=msid-semantic: WMS "+e,o=t.headerSection.split(/a=msid\-semantic: WMS.*/g),a=[];switch(o.length){case 1:a.push(o[0]);break;case 2:a.push(o[0]),a.push(n),a.push("\n");break;case 3:a.push(o[0]),a.push(n),a.push("\n"),a.push(o[2]),a.push("\n")}return t.headerSection=a.join("")},updateAudioSSRCSection:function(e,t,n,o){var a=this;a.audioSection&&(a.audioSection=a.removeSSRC(a.audioSection)),a.audioSection&&(a.audioSection=a.removeField_msid(a.audioSection)),a.audioSection&&(a.audioSection=a.audioSection+a.ssrcSection(e,t,n,o))},updateVideoSSRCSection:function(e,t,n,o){var a=this;a.videoSection&&(a.videoSection=a.removeSSRC(a.videoSection)),a.videoSection&&(a.videoSection=a.removeField_msid(a.videoSection)),a.videoSection&&(a.videoSection=a.videoSection+a.ssrcSection(e,t,n,o))},getUpdatedSDP:function(){var e=this,t="";return e.headerSection&&(t+=e.headerSection),e.audioSection&&(t+=e.audioSection),e.videoSection&&(t+=e.videoSection),t},parseMsidSemantic:function(e){var t=this,n=/a=msid\-semantic:\s*WMS (\S+)/gi,o=t._parseLine(e,n);return o&&2==o.length&&(t.msidSemantic={line:o[0],WMS:o[1]}),t.msidSemantic},ssrcSection:function(e,t,n,o){var a=["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+o,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+o,""];return a.join("\n")},parseSSRC:function(e){var t=this,n=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),o=t._parseLine(e,n);if(o){for(var a={lines:[],updateSSRCSection:t.ssrcSection},i=0;i<o.length;i++){var r=o[i];if(r.indexOf("a=ssrc")>=0)a.lines.push(r);else switch(r){case"ssrc":case"cname":case"msid":case"mslabel":case"label":a[r]=o[++i]}}return a}},_parseLine:function(e,t){for(var n,o=[];null!=(n=t.exec(e));)for(var a=0;a<n.length;a++)o.push(n[a]);if(o.length>0)return o}},d=function(e){o.extend(this,c),this.spiltSection(e)},l={streamType:"VIDEO",mediaStreamConstaints:{audio:!0,video:!0},localStream:null,rtcPeerConnection:null,offerOptions:{offerToReceiveAudio:1,offerToReceiveVideo:1},createMedia:function(e,t){function n(e){a.debug("[WebRTC-API] got local stream"),o.localStream=e;var n=o.localStream.getVideoTracks(),i=o.localStream.getAudioTracks();n.length>0&&a.debug("[WebRTC-API] Using video device: "+n[0].label),i.length>0&&a.debug("[WebRTC-API] Using audio device: "+i[0].label),t?t(o,e,o.streamType):o.onGotStream(e,o.streamType)}var o=this;return e&&"function"==typeof e&&(t=e,e=null),a.debug("[WebRTC-API] begin create media ......"),navigator.mediaDevices.getUserMedia(e||o.mediaStreamConstaints).then(n).then(o.onCreateMedia).catch(function(e){a.debug("[WebRTC-API] getUserMedia() error: ",e),o.onError(e)})},setLocalVideoSrcObject:function(e){this.onGotLocalStream(e,this.streamType),a.debug("[WebRTC-API] you can see yourself !")},createRtcPeerConnection:function(e){a.debug("[WebRTC-API] begin create RtcPeerConnection ......");var t=this;e?(!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,a.debug("[WebRTC-API] RtcPeerConnection config:",e),t.startTime=window.performance.now();var n=t.rtcPeerConnection=new RTCPeerConnection(e);a.debug("[WebRTC-API] Created local peer connection object",n),n.onicecandidate=function(e){("icecandidate"!=e.type||null!=e.candidate&&!/ tcp /.test(e.candidate.candidate))&&t.onIceCandidate(e)},n.onicestatechange=function(e){t.onIceStateChange(e)},n.oniceconnectionstatechange=function(e){t.onIceStateChange(e),"connected"==e.target.iceConnectionState&&s.intervalPrintStats(n,1),"closed"==e.target.iceConnectionState&&s.stopIntervalPrintStats()},n.onaddstream=function(e){t._onGotRemoteStream(e)}},_uploadLocalStream:function(){this.rtcPeerConnection.addStream(this.localStream),a.debug("[WebRTC-API] Added local stream to RtcPeerConnection")},createOffer:function(e,t){var n=this;return n._uploadLocalStream(),a.debug("[WebRTC-API] createOffer start..."),n.rtcPeerConnection.createOffer(n.offerOptions).then(function(t){n.offerDescription=t,a.debug("[WebRTC-API] Offer "),a.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSessionDescriptionSuccess,n.onSetSessionDescriptionError).then(function(){(e||n.onCreateOfferSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createPRAnswer:function(e,t){var n=this;return a.info(" createPRAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){a.debug("[WebRTC-API] _____________PRAnswer ",t.sdp),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive"),n.prAnswerDescription=t,a.debug("[WebRTC-API] inactive PRAnswer ",t.sdp),a.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var o=new d(t.sdp);o.updateHeaderMsidSemantic("MS_0000"),o.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),o.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=o.getUpdatedSDP(),a.debug("[WebRTC-API] Send PRAnswer ",t.sdp),(e||n.onCreatePRAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createAnswer:function(e,t){var n=this;return n._uploadLocalStream(),a.info("[WebRTC-API] createAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){if(a.debug("[WebRTC-API] _____________________Answer ",t.sdp),t.type="answer",WebIM.WebRTC.supportPRAnswer){var o=new d(t.sdp),i=o.parseMsidSemantic(o.headerSection);"*"==i.WMS&&o.updateHeaderMsidSemantic(i.WMS="MS_0000");var r=o.parseSSRC(o.audioSection),s=o.parseSSRC(o.videoSection);o.updateAudioSSRCSection(1e3,"CHROME0000",i.WMS,r.label||"LABEL_AUDIO_1000"),s&&o.updateVideoSSRCSection(2e3,"CHROME0000",i.WMS,s.label||"LABEL_VIDEO_2000"),t.sdp=o.getUpdatedSDP()}n.answerDescription=t,a.debug("[WebRTC-API] Answer ",t.sdp),a.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){if(WebIM.WebRTC.supportPRAnswer){var o=new d(t.sdp);o.updateHeaderMsidSemantic("MS_0000"),o.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),o.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=o.getUpdatedSDP()}a.debug("[WebRTC-API] Send Answer ",t.sdp),(e||n.onCreateAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},close:function(){var e=this;try{s.stopIntervalPrintStats(),e.rtcPeerConnection&&e.rtcPeerConnection.close()}catch(e){}e.localStream&&e.localStream.getTracks().forEach(function(e){e.stop()}),e.localStream=null},addIceCandidate:function(e){var t=this;if(t.rtcPeerConnection){a.debug("[WebRTC-API] Add ICE candidate: \n",e);var n=o.isArray(e)?e:[];!o.isArray(e)&&n.push(e);for(var i=0;i<n.length;i++)e=n[i],t.rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(t.onAddIceCandidateSuccess,t.onAddIceCandidateError)}},setRemoteDescription:function(e){var t=this;return a.debug("[WebRTC-API] setRemoteDescription start. "),e.sdp=e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g,"RTP/SAVPF"),a.debug("[WebRTC-API] setRemoteDescription.",e),e=new RTCSessionDescription(e),t.rtcPeerConnection.setRemoteDescription(e).then(t.onSetRemoteSuccess,t.onSetSessionDescriptionError)},iceConnectionState:function(){var e=this;return e.rtcPeerConnection.iceConnectionState},onCreateMedia:function(){a.debug("[WebRTC-API] media created.")},_onGotRemoteStream:function(e){a.debug("[WebRTC-API] onGotRemoteStream.",e),e.stream.getAudioTracks()[0].enabled=!0,e.stream.getVideoTracks()[0]&&(e.stream.getVideoTracks()[0].enabled="VIDEO"==this.streamType),this.onGotRemoteStream(e.stream,this.streamType),a.debug("[WebRTC-API] received remote stream, you will see the other.")},onGotStream:function(e,t){a.debug("[WebRTC-API] on got a local stream : "+t)},onSetRemoteSuccess:function(){a.info("[WebRTC-API] onSetRemoteSuccess complete")},onSetLocalSuccess:function(){a.info("[WebRTC-API] setLocalDescription complete")},onAddIceCandidateSuccess:function(){a.debug("[WebRTC-API] addIceCandidate success")},onAddIceCandidateError:function(e){a.debug("[WebRTC-API] failed to add ICE Candidate: "+e.toString())},onIceCandidate:function(e){a.debug("[WebRTC-API] onIceCandidate : ICE candidate: \n"+e.candidate)},onIceStateChange:function(e){a.debug("[WebRTC-API] onIceStateChange : ICE state change event: ",e)},onCreateSessionDescriptionError:function(e){a.error("[WebRTC-API] Failed to create session description: "+e.toString())},onCreateOfferSuccess:function(e){a.debug("[WebRTC-API] create offer success")},onCreatePRAnswerSuccess:function(e){a.debug("[WebRTC-API] create answer success")},onCreateAnswerSuccess:function(e){a.debug("[WebRTC-API] create answer success")},onSetSessionDescriptionError:function(e){a.error("[WebRTC-API] onSetSessionDescriptionError : Failed to set session description: "+e.toString())},onSetLocalSessionDescriptionSuccess:function(){a.debug("[WebRTC-API] onSetLocalSessionDescriptionSuccess : setLocalDescription complete")}};e.exports=function(e){o.extend(!0,this,l,e||{})}},252:function(e,t,n){"use strict";var o=n(247),a=n(250).RouteTo,i=o.logger,r=a({success:function(e){i.debug("iq to server success",e)},fail:function(e){i.debug("iq to server error",e)}}),s={_pingIntervalId:null,_p2pConfig:null,_rtcCfg:null,_rtcCfg2:null,_rtKey:null,_rtFlag:null,webRtc:null,api:null,callee:null,isCaller:!1,accepted:!1,setLocalSDP:!1,setRemoteSDP:!1,hangup:!1,init:function(){var e=this;e.api.onPing=function(){e._onPing.apply(e,arguments)},e.api.onTcklC=function(){e._onTcklC.apply(e,arguments)},e.api.onAcptC=function(){e._onAcptC.apply(e,arguments)},e.api.onAnsC=function(){e._onAnsC.apply(e,arguments)},e.api.onTermC=function(){e._onTermC.apply(e,arguments)},e.api.onEvJoin=function(){e._onEvJoin.apply(e,arguments)},e.api.onStreamControl=function(){e._onStreamControl.apply(e,arguments)},e.webRtc.onIceCandidate=function(){e._onIceCandidate.apply(e,arguments)},e.webRtc.onIceStateChange=function(){e._onIceStateChange.apply(e,arguments)}},_ping:function(){function e(){var e=new r({to:t.callee,rtKey:t._rtKey});t.api.ping(e,t._sessId,function(e,t){i.debug("ping result",t)})}var t=this;t._pingIntervalId=window.setInterval(e,5e4)},_onPing:function(e,t,n,o,a){i.debug("_onPing from",a)},initC:function(e,t){var n=this;n.sid=t,n.isCaller=!0,n.accepted=!1,n.setLocalSDP=!1,n.setRemoteSDP=!1,n.hangup=!1,n.streamType=e.audio&&e.video?"VIDEO":"VOICE",n.createLocalMedia(e)},createLocalMedia:function(e){var t=this;this.webRtc.createMedia(e,function(e,n){e.setLocalVideoSrcObject(n),t.webRtc.createRtcPeerConnection(t._rtcCfg),t.webRtc.createOffer(function(e){t._onGotWebRtcOffer(e)})})},_onGotWebRtcOffer:function(e){var t=this,n=new r({sid:t.sid,to:t.callee,rtKey:t._rtKey});t.api.initC(n,t.streamType,null,null,t._sessId,t._rtcId,null,null,e,null,t._rtcCfg2,null,function(e,t){i.debug("initc result",t)}),t.setLocalSDP=!0,t._ping()},_onAcptC:function(e,t){var n=this;t.ans&&1==t.ans?(i.info("[WebRTC-API] _onAcptC : 104, ans = 1, it is a answer. will onAcceptCall"),n.onAcceptCall(e,t,t.enableVoice!==!1,t.enableVideo!==!1),n._onAnsC(e,t)):WebIM.WebRTC.supportPRAnswer?(i.info("[WebRTC-API] _onAcptC : recv pranswer. "),(t.sdp||t.cands)&&(t.sdp&&n.webRtc.setRemoteDescription(t.sdp),n.setRemoteSDP=!0,n._handRecvCandsOrSend(e,t),n.onAcceptCall(e,t,t.enableVoice!==!1,t.enableVideo!==!1))):(i.info("[WebRTC-API] _onAcptC : not supported pranswer. drop it. will onAcceptCall"),n.setRemoteSDP=!1,n._handRecvCandsOrSend(e,t),n.onAcceptCall(e,t,t.enableVoice!==!1,t.enableVideo!==!1))},_onEvJoin:function(e,t,n,o,a){var r=this;i.debug("_onEvJoin from",a,e),r.onAcceptCall(e,t,t.enableVoice!==!1,t.enableVideo!==!1)},onAcceptCall:function(e,t,n,o){},__onVoiceOrVideo:function(e,t,n){var o=this;t.enableVoice===!1?o.onOtherUserOpenVoice(e,!1):o.onOtherUserOpenVoice(e,!0),t.enableVideo===!1?o.onOtherUserOpenVideo(e,!1):o.onOtherUserOpenVideo(e,!0)},_onStreamControl:function(e,t,n,o,a){var i=this,r=t.controlType;0===r&&i.onOtherUserOpenVoice(e,!1),1===r&&i.onOtherUserOpenVoice(e,!0),2===r&&i.onOtherUserOpenVideo(e,!1),3===r&&i.onOtherUserOpenVideo(e,!0),i.onStreamControl(e,t,n,o,a)},onStreamControl:function(e,t,n,o,a){},onOtherUserOpenVoice:function(e,t){i.debug("from open:",t," voice .",e)},onOtherUserOpenVideo:function(e,t){i.debug("from open:",t," voideo .",e)},_onAnsC:function(e,t){var n=this;i.info("[WebRTC-API] _onAnsC : recv answer. "),n.accepted=!0,t.sdp&&n.webRtc.setRemoteDescription(t.sdp),n.setRemoteSDP=!0,n._handRecvCandsOrSend(e,t),n.__onVoiceOrVideo(e,t)},_onInitC:function(e,t,n,o,a){var r=this;r.isCaller=!1,r.accepted=!1,r.setLocalSDP=!1,r.setRemoteSDP=!1,r.hangup=!1,r.callee=e,r._rtcCfg2=t.rtcCfg,r._rtKey=n,r._tsxId=o,r._fromSid=a,r._rtcId=t.rtcId,r._sessId=t.sessId,r.streamType=t.streamType,r.webRtc.createRtcPeerConnection(r._rtcCfg2),
t.sdp&&i.debug(t.sdp.sdp),t.sdp&&r.webRtc.setRemoteDescription(t.sdp).then(function(){r.setRemoteSDP=!0,r._handRecvCandsOrSend(e,t),WebIM.WebRTC.supportPRAnswer?r.webRtc.createPRAnswer(function(e){r._onGotWebRtcPRAnswer(e),setTimeout(function(){i.info("[WebRTC-API] onRinging : after send pranswer. ",r.callee),r.onRinging(r.callee,r.streamType)},500)}):(setTimeout(function(){i.info("[WebRTC-API] onRinging : After iniC, cause by: not supported pranswer. ",r.callee),r.onRinging(r.callee,r.streamType)},500),r._ping())})},_onGotWebRtcPRAnswer:function(e){var t=this,n=new r({to:t.callee,rtKey:t._rtKey});t.api.acptC(n,t._sessId,t._rtcId,e),t.setLocalSDP=!0,t._handRecvCandsOrSend(),t._ping()},onRinging:function(e,t){},accept:function(){function e(){i.info("createAndSendAnswer : ...... "),t.webRtc.createAnswer(function(e){var n=new r({to:t.callee,rtKey:t._rtKey});WebIM.WebRTC.supportPRAnswer?t.api.ansC(n,t._sessId,t._rtcId,e):t.api.acptC(n,t._sessId,t._rtcId,e,null,1),WebIM.WebRTC.supportPRAnswer||(t.setLocalSDP=!0),t._handRecvCandsOrSend(),t.accepted=!0})}var t=this,n={audio:!0};"VIDEO"==t.streamType&&(n.video=!0),t.webRtc.createMedia(n,function(t,n){t.setLocalVideoSrcObject(n),e()})},_handRecvCandsOrSend:function(e,t){var n=this;setTimeout(function(){n._onTcklC(e,t)},50),setTimeout(function(){n._onIceCandidate()},50)},_onTcklC:function(e,t){var n=this;if(n.setRemoteSDP)i.info("[WebRTC-API] recv and add cands."),n._recvCands&&n._recvCands.length>0&&n.webRtc.addIceCandidate(n._recvCands),n._recvCands&&n._recvCands.length>0&&(n._recvCands=[]),t&&t.cands&&n.webRtc.addIceCandidate(t.cands);else if(t&&t.cands&&t.cands.length>0){for(var o=0;o<t.cands.length;o++)(n._recvCands||(n._recvCands=[])).push(t.cands[o]);i.debug("[_onTcklC] temporary memory[recv] ice candidate. util setRemoteSDP = true")}},_onIceStateChange:function(e){var t=this;e&&i.debug("[WebRTC-API] "+t.webRtc.iceConnectionState()+" |||| ice state is "+e.target.iceConnectionState),e&&"closed"==e.target.iceConnectionState&&(t.setLocalSDP=!1,t.setRemoteSDP=!1),t.api.onIceConnectionStateChange(t.webRtc.iceConnectionState())},_onIceCandidate:function(e){var t=this;if(t.setLocalSDP){var n=function(e){i.debug("send ice candidate...");var n=new r({to:t.callee,rtKey:t._rtKey});e&&t.api.tcklC(n,t._sessId,t._rtcId,null,e)};t._cands&&t._cands.length>0&&(n(t._cands),t._cands=[]),e&&e.candidate&&n(e.candidate)}else e&&e.candidate&&(t._cands||(t._cands=[])).push(e.candidate),i.debug("[_onIceCandidate] temporary memory[send] ice candidate. util setLocalSDP = true")},termCall:function(e){var t=this;t._pingIntervalId&&window.clearInterval(t._pingIntervalId);var n,o=new r({to:t.callee,rtKey:t._rtKey});e||!t.isCaller&&!t.accepted&&(n="decline")||(n="success"),t.hangup||t.api.termC(o,t._sessId,t._rtcId,n),t.webRtc.close(),t.hangup=!0,t.setLocalSDP=!1,t.setRemoteSDP=!1,t.onTermCall(e)},_onTermC:function(e,t){i.debug("[_onTermC] options.reason = "+t.reason);var n=this;n.hangup=!0,n.setLocalSDP=!1,n.setRemoteSDP=!1,n.termCall(t.reason)},onTermCall:function(){}};e.exports=function(e){var t=this;o.extend(!0,this,s,e||{}),t.init()}}});